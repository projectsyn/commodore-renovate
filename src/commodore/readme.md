# Commodore manager

Extracts all Commodore components and packages from the configuration hierarchy.

By default, the manager searches for any files ending with `.yml` or `.yaml`.
It will try to parse each file and will ignore files which cannot be parsed.

To infer component and package URLs for version pins (that is, entries in `parameters.components` or `parameters.packages` which only have field `version`), the manager calls `commodore inventory show` with appropriate configurations.
See section "Configuration" for ways to configure how the inputs of the `commodore inventory show` call are generated by the manager.

The manager will optionally try to fetch cluster info from Lieutenant.
Data returned from Lieutenant will be provided to `commodore inventory show` to infer more accurate component and package URLs (e.g. if an URL is overridden for a distribution).
This feature is only available for tenant repositories, and only if configuration parameters `lieutenantURL` and `lieutenantToken` are set.

For Commodore components hosted on GitHub, the manager will use GitHub releases as the data source for detecting new versions.
For all other git hosts, it will use git refs, detecting versions from among the repository's git tags and git heads.

## Configuration

The Commodore manager requires some non-standard configurations.
Since it's not trivial to add additional configuration options directly in `renovate.json`, the manager only has a few non-standard config option in `renovate.json`.

The manager currently adds the following options to the standard renovate config:

- `extraConfig`: This config option is expected to point to another JSON file in the repository which contains further manager config.
  See below for supported keys in the additional config file.

- `globalRepoURL`: This config option can be set either globally in Renovate's `config.js` or in a tenant repo's `renovate.json`.
  This option is used by the Commodore manager to clone the global defaults repo when renovating a tenant repo.
  The manager currently requires appropriate Git credentials for any global defaults to be configured in its runtime environment.

- `tenantId`: This option must be set to the Project Syn tenant ID for each tenant repo since the manager cannot infer the tenant id from the repository name.
  If this option is not set, the manager will treat the repo as a global defaults repo.

- `lieutenantURL`: The URL of the Lieutenant API to query for cluster facts when renovating tenant repos.
  If this option is not set or the empty string, the manager will not try to query the Lieutenant API.

- `lieutenantTokenEnvVar`: The environment variable from which the Lieutenant API token is read.
  We suggest to configure a token for each required Lieutenant API as an environment variable in the Renovate runner execution environment.
  With that setup, users can select the token to use by specifying the corresponding environment variable in `lieutenantTokenEnvVar`.
  This option defaults to `LIEUTENANT_API_TOKEN`.

### Extra configuration file

The manager currently understands the following keys in the extra configuration file:

- `extraParameters`: Extra parameters which are provided to Commodore when rendering the repository hierarchy with `commodore inventory show`.
  The contents of `extraParameters` are passed to Commodore in key `parameters` of an additional inventory class.

- `distributionRegex`: A regex pattern which is used to extract the distribution (and optionally cloud) name from a file name.
  The manager expects that this regex pattern has a named capture group `distribution` which corresponds to the K8s distribution name as used in the hierarchy.
  The manager will also use a named capture group `cloud` as the cloud provider name, if it exists.
  The regex pattern should be written such that it matches the relative file path of a distribution class in the global defaults repository.

  Default: `/^distribution\/(?<distribution>[^\/]+)(?:\/cloud\/(?<cloud>.+)\.ya?ml|(?:\/.+)?\.ya?ml)$/`.

  The default regex pattern extracts the distribution (and optionally cloud) name from file names in the following forms (and additionally the same forms with `.yaml` file extensions):
  - `distribution/<distribution>.yml`
  - `distribution/<distribution>/file.yml`
  - `distribution/<distribution>/cloud/<cloud>.yml`

- `cloudRegionRegex`: A regex pattern which is used to extract the cloud provider and cloud region name from a file name.
  The manager expects that this regex pattern has a named capture group `cloud` which corresponds to the cloud provider name as used in the hierarchy.
  The manager will also use a named capture group `region` as the cloud provider region, if it exists.
  The regex pattern should be written such that it matches the relative file path of a cloud class in the global defaults repository.

  Default: `/^cloud\/(?<cloud>[^\/]+)(?:\/(?:(?<region>[^\/]+)|.+)\.ya?ml|\.ya?ml)$/`

  The default regex pattern extracts the cloud (and optionally cloud region) name from file names in the following forms (and additionally the same forms with `.yaml` file extensions):
  - `cloud/<cloud>.yml`
  - `cloud/<cloud>/<region>.yml`
  - `cloud/<cloud>/foo/bar.yml`

- `ignoreValues`: An array of strings to ignore if they appear as distribution, cloud or region values.
  The manager will not use distribution, cloud, or region values which match an entry in this array when calling `commodore inventory show`.

  Default: `['params']`.

- `factsMap`: An object mapping file names to custom cluster facts.
  Cluster facts are `distribution`, `cloud` and `region`.
  Values in the `factsMap` have precedence over facts inferred from the file name based on the regex patterns documented in this section.
  However, values returned from Lieutenant have precedence over values provided in the `factsMap`.

  Default: `{}`.

- `githubBaseUrl`: A string containing the base URL of GitHub, used to distinguish between GitHub repositories and other git hosts.

  Default: `https://github.com/`

The manager uses the results of the `distributionRegex` and `cloudRegionRegex` patterns, the values provided in `factsMap`, and the Lieutenant API response to construct an inventory class providing the facts to Commodore.

If neither `factsMap`, nor the Lieutenant API provide values for a file, the class has the following contents:

```yaml
parameters:
  facts:
    distribution: <distributionRegex.groups.distribution>
    cloud:
      # If cloudRegionRegex capture group `cloud` is present, use its value.
      # Otherwise, if distributionRegex capture group `cloud` is present use its value.
      (<cloudRegionRegex.groups.cloud> || <distributionRegex.groups.cloud>)
    region: <cloudRegionRegex.groups.region>
```

If any values are provided from the `factsMap` or Lieutenant the corresponding fields in the resulting class are set to those values instead of the values extracted from the file name with the regex pattern.
Facts for which no value has been provided from any source (regex patterns, facts map, and Lieutenant) are not present in the resulting inventory class.
